<source>
  @id fluentd-containers.log
  @type tail
  @label @KUBERNETES_CONTAINERS
  path /var/log/containers/*.log
  pos_file /var/log/containers.log.pos
  tag raw.containers.*
  read_from_head true
  <parse>
    @type multi_format
    <pattern>
      format json
      time_key time
      time_format %Y-%m-%dT%H:%M:%S.%NZ
      keep_time_key true
    </pattern>
    <pattern>
      format /^(?<time>.+) (?<stream>stdout|stderr) [^ ]* (?<log>.*)$/
      time_format %Y-%m-%dT%H:%M:%S.%N%:z
      keep_time_key true
    </pattern>
  </parse>
</source>
<label @KUBERNETES_CONTAINERS>
  <match raw.containers.**>
    @id raw.containers
    @type detect_exceptions
    remove_tag_prefix raw
    message log
    stream stream
    multiline_flush_interval 5
    max_bytes 500000
    max_lines 1000
  </match>
  <filter containers.**>
    @type kubernetes_metadata
  </filter>
  <filter **>
    @type record_transformer
    enable_ruby
    <record>
      container_id ${record['docker']['container_id']}
    </record>
  </filter>
  <filter **>
    @type concat
    key log
    stream_identity_key container_id
    multiline_end_regexp /\n$/
    separator " "
    flush_interval 30
  </filter>
  <filter **>
    @type record_transformer
    remove_keys container_id
  </filter>
  <match containers.**>
      @type rewrite_tag_filter
      <rule>
        key $.kubernetes.container_name
        pattern ^(.+)$
        tag $1.${tag}
      </rule>
  </match>
  <match {heapster,influxdb,grafana,fluentd-coralogix}.containers.**>
    @type null
  </match>
  <filter *.containers.**>
    @type parser
    key_name log
    reserve_time true
    reserve_data true
    remove_key_name_field true
    replace_invalid_sequence true
    emit_invalid_record_to_error false
    <parse>
      @type json
      keep_time_key true
    </parse>
  </filter>
  <match *.containers.**>
    @type coralogix
    privatekey "#{ENV['CORALOGIX_PRIVATE_KEY']}"
    appname "$kubernetes.namespace_name"
    subsystemname "$kubernetes.container_name"
    timestamp_key_name time
    is_json true
  </match>
</label>